<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription au Grand Jeu Immersif</title>
</head>

<body>
    <h1>Inscription au Grand Jeu Immersif √† √âpinac</h1>

    <form id="registration-form">
        <label for="team-name">Nom de l'√©quipe :</label>
        <input type="text" id="team-name" name="team_name" required><br><br>

        <label for="phone-number">Num√©ro de t√©l√©phone :</label>
        <input type="tel" id="phone-number" name="phone_number" required placeholder="Ex : 0612345678"><br><br>
        <p style="color: red;"><strong>‚ö† Le num√©ro de t√©l√©phone est obligatoire et doit √™tre un num√©ro fran√ßais valide.</strong></p>

        <label for="participants">Nombre de participants :</label>
        <input type="number" id="participants" name="participants" min="1" required><br><br>

        <!-- BOUTONS : Test & Paiement -->
        <button type="button" onclick="testTelegram()">TEST - Envoi Telegram sans payer</button>
        <button type="button" onclick="redirectToPayPal(event)">S'inscrire et payer avec PayPal</button>
    </form>

    <script type="module">
        // R√©cup√©rer les variables Netlify
        const token = import.meta.env.VITE_TELEGRAM_BOT_TOKEN;
        const chatId = import.meta.env.VITE_TELEGRAM_CHAT_ID;

        function validatePhoneNumber(phone) {
            const regex = /^(\+33|0)[1-9]\d{8}$/; // V√©rifie si le num√©ro est un num√©ro fran√ßais valide
            return regex.test(phone);
        }

        function sendTelegramMessage() {
            let teamName = document.getElementById("team-name").value;
            let phoneNumber = document.getElementById("phone-number").value;
            let participants = document.getElementById("participants").value;

            if (!validatePhoneNumber(phoneNumber)) {
                alert("‚ùå Erreur : Veuillez entrer un num√©ro de t√©l√©phone fran√ßais valide.");
                return Promise.resolve(false);
            }

            let message = `üìå **Nouvelle Inscription !**\n\n
            üë• **√âquipe** : ${teamName}\n
            üìû **T√©l√©phone** : ${phoneNumber}\n
            üéüÔ∏è **Participants** : ${participants}\n\n
            ‚úÖ Merci pour votre inscription ! Vous recevrez bient√¥t votre premi√®re question.`;

            let url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;

            return fetch(url)
                .then(response => {
                    if (response.ok) {
                        console.log("‚úÖ Message Telegram envoy√© !");
                        alert("‚úÖ Inscription valid√©e sur Telegram !");
                        return true;
                    } else {
                        console.error("‚ùå Erreur lors de l'envoi du message Telegram");
                        alert("‚ùå Erreur : Impossible d'envoyer l'inscription √† Telegram.");
                        return false;
                    }
                })
                .catch(error => {
                    console.error("‚ùå Erreur Telegram :", error);
                    alert("‚ùå Erreur : Probl√®me avec l'envoi du message.");
                    return false;
                });
        }

        function testTelegram() {
            sendTelegramMessage().then(success => {
                if (success) {
                    alert("‚úÖ Test r√©ussi : Message envoy√© sur Telegram !");
                } else {
                    alert("‚ùå Test √©chou√© : V√©rifiez vos param√®tres.");
                }
            });
        }

        function redirectToPayPal(event) {
            event.preventDefault();

            sendTelegramMessage().then(success => {
                if (success) {
                    let participants = document.getElementById("participants").value;
                    let totalPrice = 5 * participants;
                    let paypalLink = `https://www.paypal.me/LaurieBlanot?country.x=FR&locale.x=fr_FR&amount=${totalPrice}EUR`;

                    alert(`‚úÖ Inscription valid√©e ! Montant √† payer : ${totalPrice} ‚Ç¨`);
                    window.open(paypalLink, "_blank"); 
                }
            });
        }
    </script>

</body>
</html>